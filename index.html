<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QuizBox – JSON‑Quiz</title>
    <!-- Bootstrap 5 -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      /* Feedbackfarben (Bootstrap 5‑Palette) */
      .correct {
        background-color: #d1e7dd !important; /* success‑subtle */
      }
      .incorrect {
        background-color: #f8d7da !important; /* danger‑subtle */
      }
      .missed {
        background-color: #fff3cd !important; /* warning‑subtle */
      }
    </style>
  </head>
  <body class="bg-light py-4">
    <div class="container">
      <h1 class="text-center mb-4">QuizBox</h1>

      <!-- Datei‑Upload -->
      <div class="mb-4">
        <label for="fileInput" class="form-label"
          >Quiz‑Datei hochladen (.json)</label
        >
        <input
          type="file"
          id="fileInput"
          accept="application/json"
          class="form-control"
        />
      </div>

      <!-- Quiz‑Container -->
      <section id="quizContainer" class="d-none">
        <div class="progress mb-2" style="height: 1rem">
          <div
            id="progressBar"
            class="progress-bar bg-primary"
            style="width: 0%"
          ></div>
        </div>
        <p id="progressText" class="small text-muted"></p>

        <div class="card shadow-sm mb-3">
          <div class="card-body">
            <h2 id="questionText" class="h5"></h2>
            <form
              id="answersForm"
              class="list-group list-group-flush mt-3"
            ></form>
          </div>
        </div>

        <button id="checkButton" type="button" class="btn btn-primary me-2">
          Antwort prüfen
        </button>
        <button id="nextButton" type="button" class="btn btn-secondary d-none">
          Nächste Frage
        </button>
      </section>

      <!-- Ergebnis‑Container -->
      <section id="resultsContainer" class="d-none">
        <div class="alert alert-info" role="alert">
          <h2 class="h5 mb-3">Ergebnis</h2>
          <p id="resultsText" class="mb-0"></p>
        </div>
        <button
          id="restartButton"
          type="button"
          class="btn btn-outline-primary"
        >
          Neues Quiz
        </button>
      </section>
    </div>

    <script>
      /* === DOM‑Elemente === */
      const fileInput = document.getElementById("fileInput");
      const quizContainer = document.getElementById("quizContainer");
      const questionText = document.getElementById("questionText");
      const answersForm = document.getElementById("answersForm");
      const checkButton = document.getElementById("checkButton");
      const nextButton = document.getElementById("nextButton");
      const progressBar = document.getElementById("progressBar");
      const progressText = document.getElementById("progressText");
      const resultsContainer = document.getElementById("resultsContainer");
      const resultsText = document.getElementById("resultsText");
      const restartButton = document.getElementById("restartButton");

      /* === State === */
      // Schlüssel enthält Pfad, damit mehrere GitHub‑Pages‑Projekte dieselbe Domain teilen können
      const STORAGE_KEY = `quizState_${location.pathname}`;
      let questions = [];
      let currentIndex = 0;
      let correctCount = 0;

      /* === LocalStorage‑Helfer === */
      function saveState() {
        try {
          const data = { questions, currentIndex, correctCount };
          localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        } catch (err) {
          console.warn("LocalStorage speichern fehlgeschlagen:", err);
        }
      }
      function clearState() {
        localStorage.removeItem(STORAGE_KEY);
      }

      /* === Utility === */
      const arraysEqual = (a, b) =>
        a.length === b.length && b.every((x) => a.includes(x));

      /* === UI‑Updates === */
      function updateProgress() {
        const percent = (currentIndex / questions.length) * 100;
        progressBar.style.width = `${percent}%`;
        progressText.textContent = `${currentIndex} / ${questions.length} beantwortet`;
      }

      function renderQuestion() {
        const q = questions[currentIndex];
        questionText.textContent = q.question;
        answersForm.innerHTML = "";
        q.answers.forEach((answer, idx) => {
          const id = `answer-${idx}`;
          const item = document.createElement("div");
          item.className = "list-group-item list-group-item-action";

          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.className = "form-check-input me-2";
          checkbox.name = "answers";
          checkbox.value = answer;
          checkbox.id = id;

          const label = document.createElement("label");
          label.className = "form-check-label";
          label.htmlFor = id;
          label.textContent = answer;

          item.appendChild(checkbox);
          item.appendChild(label);
          answersForm.appendChild(item);
        });
        checkButton.disabled = false;
        nextButton.classList.add("d-none");
        updateProgress();
        saveState();
      }

      /* === Quiz‑Logik === */
      function checkAnswer() {
        const q = questions[currentIndex];
        const correctAnswers = q.correctAnswers;
        const userAnswers = Array.from(
          answersForm.querySelectorAll("input[name='answers']:checked")
        ).map((el) => el.value);

        // Feedback einfärben
        answersForm.querySelectorAll(".list-group-item").forEach((item) => {
          const checkbox = item.querySelector("input");
          const value = checkbox.value;
          if (correctAnswers.includes(value) && checkbox.checked)
            item.classList.add("correct");
          else if (!correctAnswers.includes(value) && checkbox.checked)
            item.classList.add("incorrect");
          else if (correctAnswers.includes(value) && !checkbox.checked)
            item.classList.add("missed");
          checkbox.disabled = true;
        });

        // Bewertung
        if (arraysEqual(userAnswers.sort(), [...correctAnswers].sort()))
          correctCount++;

        checkButton.disabled = true;
        nextButton.classList.remove("d-none");
        currentIndex++;
        updateProgress();
        saveState();
        if (currentIndex === questions.length)
          nextButton.textContent = "Auswertung anzeigen";
      }

      function nextQuestion() {
        if (currentIndex < questions.length) renderQuestion();
        else endQuiz();
      }

      function endQuiz() {
        quizContainer.classList.add("d-none");
        resultsContainer.classList.remove("d-none");
        const percent = ((correctCount / questions.length) * 100).toFixed(0);
        resultsText.textContent = `Du hast ${correctCount} / ${questions.length} Fragen korrekt beantwortet (≈ ${percent}% ).`;
        clearState(); // Quiz abgeschlossen ⇒ gespeicherten Stand entfernen
      }

      function resetState() {
        currentIndex = 0;
        correctCount = 0;
        updateProgress();
        saveState();
      }

      /* === Event‑Handler === */
      fileInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (evt) => {
          try {
            const data = JSON.parse(evt.target.result);
            if (!Array.isArray(data)) throw new Error("JSON ist kein Array");
            questions = data;
            resultsContainer.classList.add("d-none");
            quizContainer.classList.remove("d-none");
            resetState(); // setzt Index zurück und speichert sofort
            renderQuestion();
          } catch (err) {
            alert("Ungültiges JSON‑Format: " + err.message);
          }
        };
        reader.readAsText(file, "UTF-8");
      });

      checkButton.addEventListener("click", checkAnswer);
      nextButton.addEventListener("click", nextQuestion);
      restartButton.addEventListener("click", () => {
        questions = [];
        clearState();
        resultsContainer.classList.add("d-none");
        quizContainer.classList.add("d-none");
        fileInput.value = "";
      });

      /* === Beim Laden: gespeicherten Stand wiederherstellen === */
      window.addEventListener("DOMContentLoaded", () => {
        try {
          const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || "null");
          if (
            saved &&
            Array.isArray(saved.questions) &&
            saved.questions.length
          ) {
            if (
              confirm(
                "Ein gespeichertes Quiz wurde gefunden. Möchtest du fortsetzen?"
              )
            ) {
              questions = saved.questions;
              currentIndex = saved.currentIndex || 0;
              correctCount = saved.correctCount || 0;
              quizContainer.classList.remove("d-none");
              if (currentIndex < questions.length) renderQuestion();
              else endQuiz();
            } else {
              clearState();
            }
          }
        } catch (err) {
          console.warn(
            "Gespeicherter Quiz‑State konnte nicht gelesen werden:",
            err
          );
          clearState();
        }
      });
    </script>
  </body>
</html>
